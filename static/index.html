<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tizimi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-theme-button-color: #0088cc; --tg-theme-text-color: #000; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input { width: 90%; padding: 12px; margin: 15px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; }
        button { background: var(--tg-theme-button-color); color: white; border: none; width: 100%; padding: 12px; border-radius: 10px; font-size: 18px; cursor: pointer; transition: 0.3s; }
        #timer { font-size: 24px; color: #e74c3c; font-weight: bold; margin-bottom: 20px; }
        .hidden { display: none; }
        .option-btn { background: #f8f9fa; color: black; border: 1px solid #ddd; margin: 5px 0; text-align: left; font-size: 14px; }
        .option-btn:active { background: #e0e0e0; }
    </style>
</head>
<body>
    <div id="home" class="card">
        <h2 style="color: #0088cc;">Test Markazi</h2>
        <p>Davom etish uchun test kodini kiriting:</p>
        <input type="text" id="testCode" placeholder="Masalan: 777">
        <button onclick="startTest()">Kirish</button>
    </div>

    <div id="quiz" class="card hidden">
        <div id="timer">00:00</div>
        <div id="questionBox">
            <h3 id="qText">Savol yuklanmoqda...</h3>
            <div id="options"></div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let currentTest = null;
        let timerInterval;

        async function startTest() {
            const code = document.getElementById('testCode').value;
            // API orqali testni olish (Sizning hosting manzilingiz bo'ladi)
            const response = await fetch(`/get_test/${code}`);
            const data = await response.json();

            if (data.error) return alert("Kod noto'g'ri!");

            currentTest = data;
            document.getElementById('home').classList.add('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            
            runTimer(data.time * 60);
            showQuestion(0);
        }

        function runTimer(sec) {
            timerInterval = setInterval(() => {
                let m = Math.floor(sec / 60), s = sec % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (sec-- <= 0) finish(0);
            }, 1000);
        }

        function showQuestion(idx) {
            const q = currentTest.questions[idx];
            document.getElementById('qText').innerText = q.q;
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = "";
            q.o.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn";
                btn.innerText = opt;
                btn.onclick = () => { /* Natijani hisoblash logikasi */ finish(1); };
                optDiv.appendChild(btn);
            });
        }

        function finish(score) {
            clearInterval(timerInterval);
            tg.sendData(JSON.stringify({score: score, code: document.getElementById('testCode').value}));
            tg.close();
        }
    </script>
</body>
</html>
